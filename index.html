<!DOCTYPE html>
<html lang="en">
<head>


      
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Camera Capture with Live Transformation</title>
        <style>
            /* ... (keep the existing styles) ... */
              </style>
              </head>
              <body>
                <!-- ... (keep the existing HTML structure) ... -->
                  
                    <script>
                        const video = document.getElementById('video');
                            const canvas = document.getElementById('canvas');
                                const captureBtn = document.getElementById('captureBtn');
                                    const saveBtn = document.getElementById('saveBtn');
                                        const cameraSelect = document.getElementById('cameraSelect');
                                            const imagePreview = document.getElementById('imagePreview');
                                                const context = canvas.getContext('2d');
                                                    let currentStream;

                                                        // Function to check if the browser supports the Media Devices API
                                                            function hasGetUserMedia() {
                                                                  return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
                                                                      }

                                                                          // Function to request camera access
                                                                              async function requestCameraAccess() {
                                                                                    try {
                                                                                            await navigator.mediaDevices.getUserMedia({ video: true });
                                                                                                    console.log("Camera access granted");
                                                                                                          } catch (error) {
                                                                                                                  console.error("Failed to request camera access:", error);
                                                                                                                          alert("This website needs access to your camera. Please allow it.");
                                                                                                                                }
                                                                                                                                    }

                                                                                                                                        // Start the selected camera
                                                                                                                                            function startCamera(deviceId) {
                                                                                                                                                  stopCamera();  // Stop any previously running stream

                                                                                                                                                        navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } })
                                                                                                                                                                .then(stream => {
                                                                                                                                                                          currentStream = stream;
                                                                                                                                                                                    video.srcObject = stream;
                                                                                                                                                                                            })
                                                                                                                                                                                                    .catch(error => {
                                                                                                                                                                                                              console.error("Camera access error: ", error);
                                                                                                                                                                                                                        alert("Failed to access the camera. Please try again.");
                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                        // Get available video input devices (cameras)
                                                                                                                                                                                                                                            function enumerateDevices() {
                                                                                                                                                                                                                                                  return navigator.mediaDevices.enumerateDevices().catch(function(error) {
                                                                                                                                                                                                                                                          console.error("Error enumerating devices: ", error);
                                                                                                                                                                                                                                                                  throw error;
                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                // Main initialization function
                                                                                                                                                                                                                                                                                    async function init() {
                                                                                                                                                                                                                                                                                          if (!hasGetUserMedia()) {
                                                                                                                                                                                                                                                                                                  console.log("getUserMedia is not supported");
                                                                                                                                                                                                                                                                                                          return;
                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                      await requestCameraAccess();

                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                    const devices = await enumerateDevices();
                                                                                                                                                                                                                                                                                                                                            const videoDevices = devices.filter(device => device.kind === 'videoinput');
                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                            videoDevices.forEach((device, index) => {
                                                                                                                                                                                                                                                                                                                                                                      const option = document.createElement('option');
                                                                                                                                                                                                                                                                                                                                                                                option.value = device.deviceId;
                                                                                                                                                                                                                                                                                                                                                                                          option.text = device.label || `Camera ${index + 1}`;
                                                                                                                                                                                                                                                                                                                                                                                                    cameraSelect.appendChild(option);
                                                                                                                                                                                                                                                                                                                                                                                                            });

                                                                                                                                                                                                                                                                                                                                                                                                                    if (videoDevices.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                              startCamera(videoDevices[0].deviceId);
                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                            } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.error("Initialization failed:", error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                            alert("An error occurred during initialization. Please try again later.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // Event listeners
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              cameraSelect.addEventListener('change', () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const selectedDeviceId = cameraSelect.value;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          startCamera(selectedDeviceId);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  captureBtn.addEventListener('click', () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const width = video.videoWidth;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const height = video.videoHeight;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    handleOrientation(width, height);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const imageData = canvas.toDataURL();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                imagePreview.src = imageData;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      imagePreview.style.display = 'block';

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            saveBtn.disabled = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    saveBtn.addEventListener('click', () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const link = document.createElement('a');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const dateTimeStamp = getDateTimeStamp();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      link.download = `captured_image_${dateTimeStamp}.png`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            link.href = canvas.toDataURL();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  link.click();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          window.onload = init;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </html>
